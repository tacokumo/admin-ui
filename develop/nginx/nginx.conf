# イベント処理の設定
events {
    # 1つのワーカープロセスが同時に処理できる接続数の上限
    worker_connections 1024;
}

# HTTPモジュールの設定
http {
    # MIMEタイプの設定を含める
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # バックエンドサーバーのグループ定義
    upstream admin_ui {
        # admin-uiコンテナのポート80にリクエストを転送（production build via nginx）
        server admin-ui:80;
    }

    # HTTPS server for browser
    server {
        # ポート443でSSL/TLS接続を待ち受け
        listen 443 ssl;
        # このサーバーブロックが処理するホスト名
        server_name localhost;

        # TLS termination for browser
        # SSL証明書のパス
        ssl_certificate /etc/nginx/certs/nginx-server.crt;
        # 秘密鍵のパス
        ssl_certificate_key /etc/nginx/certs/nginx-server.key;
        # 使用を許可するTLSバージョン
        ssl_protocols TLSv1.2 TLSv1.3;
        # 強度の高い暗号スイートのみ許可
        ssl_ciphers HIGH:!aNULL:!MD5;

        # Admin UI
        location / {
            # upstreamで定義したadmin_uiへリクエストを転送
            proxy_pass http://admin_ui;
            # 元のHostヘッダーをバックエンドに転送
            proxy_set_header Host $host;
            # クライアントの実IPアドレスを転送
            proxy_set_header X-Real-IP $remote_addr;
            # プロキシチェーンの情報を転送
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            # 元のプロトコル(https)を転送
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # HTTP to HTTPS redirect
    server {
        # ポート80でHTTP接続を待ち受け
        listen 80;
        # このサーバーブロックが処理するホスト名
        server_name localhost;
        # 全てのリクエストをHTTPSにリダイレクト(301=恒久的)
        return 301 https://$host$request_uri;
    }
}
